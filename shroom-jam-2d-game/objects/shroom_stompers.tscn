[gd_scene load_steps=2 format=3 uid="uid://dail5offrt48s"]

[sub_resource type="GDScript" id="GDScript_on0ai"]
script/source = "extends Node2D
class_name ShroomManager

@onready var score_label: Label = $\"../UI/ScoreLabel\"
@onready var timer_label: Label = $\"../UI/TimerLabel\"

var holes: Array[ShroomHole] = []
var score: int = 0
var time_left: float = 60.0
var target_score: int = 30
var game_active: bool = false

func start_game():
	game_active = true
	visible = true
	_spawn_shrooms()

func stop_game():
	game_active = false
	visible = false
	DialogueManager.update_variable(\"shroom_score\", score)  # FIXED: use update_variable()

func _spawn_shrooms():
	for i in 16:
		var hole_scene = preload(\"res://objects/shroom_hole.tscn\")
		var hole = hole_scene.instantiate()
		hole.position = Vector2(
			(i % 4) * 80 + 200,
			(i / 4) * 80 + 200
		)
		hole.is_bad_shroom = randf() > 0.3
		hole.shroom_whacked.connect(_on_shroom_whacked)
		add_child(hole)
		holes.append(hole)

func _process(delta):
	if not game_active: return
	
	time_left -= delta
	timer_label.text = \"Time: \" + str(int(time_left))
	
	if time_left <= 0:
		stop_game()

func _on_shroom_whacked(is_good_whack: bool):
	if is_good_whack:
		score += 10
	else:
		score -= 5
		jumpscare()
	
	score_label.text = \"Score: \" + str(score)
	if score >= target_score:
		stop_game()

func jumpscare():
	var flash = ColorRect.new()
	flash.color = Color.RED
	flash.size = get_viewport_rect().size
	get_viewport().add_child(flash)
	var tween = create_tween()
	tween.tween_property(flash, \"modulate:a\", 0, 0.3)
	await tween.finished
	flash.queue_free()
"

[node name="ShroomStompers" type="Node2D"]

[node name="ShroomManager" type="Node2D" parent="."]
script = SubResource("GDScript_on0ai")

[node name="UI" type="CanvasLayer" parent="."]

[node name="ScoreLabel" type="Label" parent="UI"]
offset_right = 61.0
offset_bottom = 23.0
text = "Score: 0"

[node name="TimerLabel" type="Label" parent="UI"]
offset_top = 27.0
offset_right = 65.0
offset_bottom = 51.0
text = "Time: 60"

[node name="Instructions" type="Label" parent="UI"]
offset_top = 57.0
offset_right = 92.0
offset_bottom = 82.0
text = "E to stomp! "
